<dashboard>
  <label>Issue Reporting Dashboard</label>
  
  <!-- Input row with single fieldset for all inputs -->
  <row>
    <panel>
      <title>Email Configuration</title>
      <input type="text" token="support_email">
        <label>Support Email</label>
        <default>support@example.com</default>
      </input>
      <input type="text" token="manager_email">
        <label>Manager Email</label>
        <default>manager@example.com</default>
      </input>
      <input type="text" token="incident_id">
        <label>Incident ID</label>
        <default></default>
      </input>
    </panel>
  </row>
  
  <!-- Report Issue Button Row -->
  <row>
    <panel>
      <title>Issue Report Tool</title>
      <html>
        <![CDATA[
        <style>
          /* Splunk-friendly styles */
          .issue-report-container {
              font-family: Splunk Platform Sans, Roboto, Helvetica Neue, Helvetica, Arial, sans-serif;
              padding: 10px;
          }
          .issue-report-button {
              display: inline-block;
              background-color: #5C9BD1;
              color: white;
              padding: 8px 16px;
              text-decoration: none;
              border-radius: 4px;
              font-weight: bold;
              margin: 10px 0;
              cursor: pointer;
          }
          .issue-report-button:hover {
              background-color: #3D71A1;
          }
          .tooltip {
              position: relative;
              display: inline-block;
              margin-left: 10px;
              cursor: pointer;
          }
          .tooltip .tooltiptext {
              visibility: hidden;
              width: 400px;
              background-color: #333;
              color: #fff;
              text-align: left;
              border-radius: 6px;
              padding: 10px;
              position: absolute;
              z-index: 1;
              bottom: 125%;
              left: 50%;
              transform: translateX(-50%);
              opacity: 0;
              transition: opacity 0.3s;
              font-size: 12px;
              line-height: 1.5;
          }
          .tooltip:hover .tooltiptext {
              visibility: visible;
              opacity: 1;
          }
          .email-info {
              margin-bottom: 15px;
              background-color: #f5f5f5;
              padding: 10px;
              border-radius: 5px;
              border: 1px solid #ddd;
          }
          .email-info p {
              margin: 5px 0;
          }
          .email-info strong {
              display: inline-block;
              width: 80px;
          }
        </style>

        <div class="issue-report-container">
          <div class="email-info">
            <p><strong>To:</strong> <span id="displayTo">$support_email$</span></p>
            <p><strong>CC:</strong> <span id="displayCC">$manager_email$</span></p>
            <p><strong>Subject:</strong> <span id="displaySubject">Incident Report: $incident_id$</span></p>
          </div>
          
          <a class="issue-report-button" id="mailtoLink" target="_blank">Send Email Report</a>
          
          <div class="tooltip">ⓘ
              <span class="tooltiptext">
                  <strong>Email Template Fields:</strong><br>
                  • Flow<br>
                  • Issue subject<br>
                  • Issue details<br>
                  • Incident Reference #<br>
                  • Severity and Priority<br>
                  • When was the issue first identified<br>
                  • Impact ($ value, customer numbers, intermittent)<br>
                  • Lower environment testing status<br>
                  • Supporting details
              </span>
          </div>
          
          <script>
            require([
                'jquery',
                'splunkjs/mvc',
                'splunkjs/mvc/tokenutils'
            ], function($, mvc, TokenUtils) {
                // Get tokens
                var defaultTokenModel = mvc.Components.get('default');
                var submittedTokenModel = mvc.Components.get('submitted');
                
                // Function to update the display and mailto link
                function updateMailtoLink() {
                    var toEmail = TokenUtils.getToken('support_email', defaultTokenModel) || 'support@example.com';
                    var ccEmail = TokenUtils.getToken('manager_email', defaultTokenModel) || 'manager@example.com';
                    var incidentId = TokenUtils.getToken('incident_id', defaultTokenModel) || '';
                    var subject = 'Incident Report' + (incidentId ? ': ' + incidentId : '');
                    
                    // Update display
                    $('#displayTo').text(toEmail);
                    $('#displayCC').text(ccEmail);
                    $('#displaySubject').text(subject);
                    
                    // Encode for mailto
                    var toEmailEnc = encodeURIComponent(toEmail);
                    var ccEmailEnc = encodeURIComponent(ccEmail);
                    var subjectEnc = encodeURIComponent(subject);
                    
                    var bodyContent = "Flow%3A%0A%0AIssue%20subject%3A%0A%0AIssue%20details%3A%0A%0AIncident%20Reference%20%23%3A%20" + 
                        encodeURIComponent(incidentId) + 
                        "%0A%0ASeverity%20and%20Priority%3A%0A%0AWhen%20was%20the%20issue%20first%20identified%3A%0A%0AWhat%20is%20the%20impact%20of%20the%20issue%20in%20terms%20of%3A%0A*%20overall%20dollar%20value%0A*%20customers%20numbers%0A*%20intermittent%0A%0AIs%20the%20functionality%20tested%20in%20a%20lower%20environment%3F%3A%0A%0ASupporting%20details%3A";
                    
                    var mailtoUrl = "mailto:" + toEmailEnc + "?cc=" + ccEmailEnc + "&subject=" + subjectEnc + "&body=" + bodyContent;
                    
                    $('#mailtoLink').attr('href', mailtoUrl);
                }
                
                // Listen for token changes
                defaultTokenModel.on("change", updateMailtoLink);
                submittedTokenModel.on("change", updateMailtoLink);
                
                // Initialize the mailto link on page load
                updateMailtoLink();
            });
          </script>
        </div>
        ]]>
      </html>
    </panel>
  </row>
  
  <!-- Example of additional dashboard panels -->
  <row>
    <panel>
      <title>Recent Incidents</title>
      <table>
        <search>
          <query>index=main sourcetype=incidents | sort - _time | head 10</query>
          <earliest>-24h@h</earliest>
          <latest>now</latest>
        </search>
        <option name="drilldown">row</option>
        <drilldown>
          <set token="incident_id">$row.incident_id$</set>
        </drilldown>
      </table>
    </panel>
  </row>
  
  <row>
    <panel>
      <title>Incident Metrics</title>
      <chart>
        <search>
          <query>index=main sourcetype=incidents | timechart count by severity</query>
          <earliest>-7d@d</earliest>
          <latest>now</latest>
        </search>
        <option name="charting.chart">line</option>
      </chart>
    </panel>
  </row>
</dashboard>
